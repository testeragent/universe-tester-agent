/**
 * Zapisuje wynik testu do DWÓCH miejsc:
 * 1. Google Sheets (przez API)
 * 2. tests-data.js (dla lokalnego monitora)
 *
 * Użycie:
 *   node save-test-result.js --row=5 --code=TC-NAV-012 --name="Brak podkładu" --status=PASSED --notes="Test OK"
 *   node save-test-result.js --row=5 --code=TC-NAV-012 --name="Brak podkładu" --status=FAILED --error="Element nie znaleziony"
 *   node save-test-result.js --init    // Inicjalizuj nową sesję
 *   node save-test-result.js --finish  // Zakończ sesję
 */

const fs = require('fs');
const path = require('path');
const https = require('https');
const url = require('url');

const TESTS_DATA_FILE = path.join(__dirname, '..', 'monitor', 'tests-data.js');
const GOOGLE_API_URL = 'https://script.google.com/macros/s/AKfycbzV0LbIFePBoARK0iRfH_k90Hu9LEhG1hvW-vYyBZB7uvR4t19PYYYVu5KSXJG1npVwhQ/exec';

// ==================== GOOGLE SHEETS API ====================

function makeGoogleRequest(params) {
    return new Promise((resolve, reject) => {
        const queryString = new URLSearchParams(params).toString();
        const fullUrl = `${GOOGLE_API_URL}?${queryString}`;
        const parsedUrl = new url.URL(fullUrl);

        const options = {
            hostname: parsedUrl.hostname,
            path: parsedUrl.pathname + parsedUrl.search,
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        };

        const req = https.request(options, (res) => {
            if (res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {
                const redirectUrl = new url.URL(res.headers.location);
                const redirectOptions = {
                    hostname: redirectUrl.hostname,
                    path: redirectUrl.pathname + redirectUrl.search,
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                };

                const redirectReq = https.request(redirectOptions, (redirectRes) => {
                    let data = '';
                    redirectRes.on('data', chunk => data += chunk);
                    redirectRes.on('end', () => {
                        try { resolve(JSON.parse(data)); }
                        catch (e) { resolve({ raw: data }); }
                    });
                });
                redirectReq.on('error', reject);
                redirectReq.end();
                return;
            }

            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
                try { resolve(JSON.parse(data)); }
                catch (e) { resolve({ raw: data }); }
            });
        });

        req.on('error', reject);
        req.setTimeout(30000, () => {
            req.destroy();
            reject(new Error('Request timeout'));
        });
        req.end();
    });
}

async function updateGoogleSheet(row, column, value) {
    return await makeGoogleRequest({
        action: 'updateTest',
        row: row,
        column: column,
        value: value
    });
}

// ==================== LOCAL MONITOR ====================

function readTestsData() {
    try {
        const content = fs.readFileSync(TESTS_DATA_FILE, 'utf8');
        const match = content.match(/var testData\s*=\s*(\{[\s\S]*\});?\s*$/);
        if (match) {
            return JSON.parse(match[1]);
        }
    } catch (e) {}

    // Domyślna struktura
    return {
        lastUpdate: new Date().toISOString().slice(0, 19),
        agentStatus: {
            isRunning: false,
            currentAction: "",
            lastAction: "",
            finished: false,
            startedAt: null
        },
        summary: { total: 0, passed: 0, failed: 0, blocked: 0, inProgress: 0 },
        currentTest: null,
        tests: []
    };
}

function writeTestsData(data) {
    data.lastUpdate = new Date().toISOString().slice(0, 19);
    const content = `// Auto-generated by Test Monitor\nvar testData = ${JSON.stringify(data, null, 2)};\n`;
    fs.writeFileSync(TESTS_DATA_FILE, content, 'utf8');
}

// ==================== MAIN FUNCTIONS ====================

async function initSession() {
    const now = new Date().toISOString().slice(0, 19);
    const data = {
        lastUpdate: now,
        agentStatus: {
            isRunning: true,
            currentAction: "Inicjalizacja sesji...",
            lastAction: "",
            finished: false,
            startedAt: now
        },
        summary: { total: 0, passed: 0, failed: 0, blocked: 0, inProgress: 0 },
        currentTest: null,
        tests: []
    };
    writeTestsData(data);
    return { success: true, action: 'init', startedAt: now };
}

async function finishSession() {
    const data = readTestsData();
    const now = new Date().toISOString().slice(0, 19);

    data.agentStatus.isRunning = false;
    data.agentStatus.finished = true;
    data.agentStatus.finishedAt = now;
    data.agentStatus.currentAction = "Sesja zakończona";
    data.currentTest = null;
    data.summary.inProgress = 0;

    writeTestsData(data);
    return { success: true, action: 'finish', finishedAt: now, summary: data.summary };
}

async function setCurrentTest(code, name, steps = []) {
    const data = readTestsData();
    const now = new Date().toISOString().slice(0, 19);

    data.agentStatus.currentAction = `Wykonuję: ${code}`;
    data.currentTest = {
        code: code,
        name: name,
        allSteps: steps,
        currentStepIndex: 0,
        steps: [],
        startedAt: now
    };
    data.summary.inProgress = 1;

    writeTestsData(data);
    return { success: true, action: 'setCurrentTest', code: code };
}

async function updateStep(stepIndex, description, status) {
    const data = readTestsData();

    if (data.currentTest) {
        data.currentTest.currentStepIndex = stepIndex;
        data.currentTest.steps.push({
            step: stepIndex + 1,
            description: description,
            status: status
        });
        data.agentStatus.currentAction = `${data.currentTest.code}: ${description}`;
    }

    writeTestsData(data);
    return { success: true, action: 'updateStep', stepIndex: stepIndex };
}

async function saveTestResult(params) {
    const { row, code, name, status, notes, error, steps } = params;
    const now = new Date().toISOString().slice(0, 19);
    const today = now.slice(0, 10);

    // 1. AKTUALIZUJ GOOGLE SHEETS
    let googleResult = { success: false };
    try {
        if (status === 'PASSED') {
            await updateGoogleSheet(row, 'Completed At', today);
        }
        await updateGoogleSheet(row, 'Last Modified', today);

        // Dodaj notatkę o wyniku
        const resultNote = `[${today}] ${status}: ${notes || error || ''}`;
        googleResult = await updateGoogleSheet(row, 'Notes', resultNote);
    } catch (e) {
        googleResult = { success: false, error: e.message };
    }

    // 2. AKTUALIZUJ LOKALNY MONITOR
    const data = readTestsData();

    // Dodaj test do listy
    const testResult = {
        code: code,
        name: name,
        status: status.toLowerCase(),
        startedAt: data.currentTest?.startedAt || now,
        finishedAt: now,
        steps: steps || data.currentTest?.steps || [],
        error: error || null,
        notes: notes || null
    };

    // Oblicz czas trwania
    if (testResult.startedAt) {
        const start = new Date(testResult.startedAt);
        const end = new Date(testResult.finishedAt);
        const diffMs = end - start;
        testResult.duration = `${Math.round(diffMs / 1000)}s`;
    }

    data.tests.push(testResult);

    // Aktualizuj summary
    if (status === 'PASSED') data.summary.passed++;
    else if (status === 'FAILED') data.summary.failed++;
    else if (status === 'BLOCKED') data.summary.blocked++;

    data.summary.total = data.tests.length;
    data.summary.inProgress = 0;

    // Wyczyść currentTest
    data.currentTest = null;
    data.agentStatus.lastAction = `${code}: ${status}`;
    data.agentStatus.currentAction = "Oczekiwanie...";

    writeTestsData(data);

    return {
        success: true,
        googleSheets: googleResult,
        localMonitor: { saved: true, testsCount: data.tests.length },
        summary: data.summary
    };
}

// ==================== CLI ====================

async function main() {
    const args = process.argv.slice(2);

    // Parse arguments
    const params = {};
    args.forEach(arg => {
        if (arg.startsWith('--')) {
            const eqIndex = arg.indexOf('=');
            if (eqIndex > 0) {
                const key = arg.slice(2, eqIndex);
                const value = arg.slice(eqIndex + 1);
                params[key] = value;
            } else {
                params[arg.slice(2)] = true;
            }
        }
    });

    try {
        let result;

        if (params.init) {
            result = await initSession();
        } else if (params.finish) {
            result = await finishSession();
        } else if (params.setTest) {
            result = await setCurrentTest(params.code, params.name, params.steps?.split('|') || []);
        } else if (params.step !== undefined) {
            result = await updateStep(parseInt(params.step), params.desc || '', params.status || 'passed');
        } else if (params.row && params.status) {
            result = await saveTestResult(params);
        } else {
            console.log(`
Zapisuje wynik testu do Google Sheets + lokalnego monitora

Użycie:
  --init                          Inicjalizuj sesję
  --finish                        Zakończ sesję
  --setTest --code=X --name=Y     Ustaw aktualny test
  --step=N --desc="..." --status=passed/failed  Aktualizuj krok

  --row=N --code=X --name=Y --status=PASSED --notes="..."
  --row=N --code=X --name=Y --status=FAILED --error="..."

Przykład:
  node save-test-result.js --init
  node save-test-result.js --setTest --code=TC-NAV-012 --name="Brak podkładu"
  node save-test-result.js --row=2 --code=TC-NAV-012 --name="Brak podkładu" --status=PASSED --notes="Test OK"
  node save-test-result.js --finish
`);
            process.exit(0);
        }

        console.log(JSON.stringify(result, null, 2));

    } catch (e) {
        console.error(JSON.stringify({ error: e.message }));
        process.exit(1);
    }
}

main();
