/**
 * Czyści "zawieszone" sesje agenta testera
 *
 * Wywoływane automatycznie przy starcie agenta.
 * Jeśli poprzednia sesja nie zakończyła się poprawnie (isRunning=true, ale lastUpdate > 2 min),
 * automatycznie resetuje status.
 *
 * Użycie:
 * node cleanup-stale-session.js
 *
 * Exit codes:
 * 0 - OK (brak starej sesji lub wyczyszczona)
 * 1 - Błąd
 */

const fs = require('fs');
const path = require('path');

const MONITOR_FILE = path.join(__dirname, '..', 'monitor', 'tests-data.js');
const STALE_THRESHOLD_MS = 2 * 60 * 1000; // 2 minuty

function cleanupStaleSession() {
    try {
        // Sprawdź czy plik istnieje
        if (!fs.existsSync(MONITOR_FILE)) {
            console.log('CLEANUP: Brak pliku tests-data.js - OK');
            return;
        }

        // Odczytaj aktualny plik
        const content = fs.readFileSync(MONITOR_FILE, 'utf8');

        // Wyciągnij obiekt testData
        const match = content.match(/var testData\s*=\s*(\{[\s\S]*\});?\s*$/);
        if (!match) {
            console.log('CLEANUP: Nie można sparsować pliku - pomijam');
            return;
        }

        let testData;
        try {
            testData = JSON.parse(match[1]);
        } catch (e) {
            console.log('CLEANUP: Błąd parsowania JSON - pomijam');
            return;
        }

        // Sprawdź czy sesja jest "zawieszona"
        const agentStatus = testData.agentStatus || {};

        if (!agentStatus.isRunning) {
            console.log('CLEANUP: Poprzednia sesja zakończona poprawnie - OK');
            return;
        }

        // Sesja oznaczona jako działająca - sprawdź jak dawno była ostatnia aktualizacja
        const lastUpdate = testData.lastUpdate;
        if (!lastUpdate) {
            console.log('CLEANUP: Brak lastUpdate - resetuję');
            resetSession(testData, 'Brak lastUpdate - sesja nieważna');
            return;
        }

        const lastUpdateTime = new Date(lastUpdate).getTime();
        const now = Date.now();
        const ageMs = now - lastUpdateTime;

        if (ageMs > STALE_THRESHOLD_MS) {
            const ageMinutes = Math.round(ageMs / 60000);
            console.log(`CLEANUP: Wykryto zawieszoną sesję (${ageMinutes} min bez aktualizacji) - resetuję`);
            resetSession(testData, `Sesja zawieszona - ${ageMinutes} min bez aktualizacji`);
        } else {
            // Sesja aktywna - to może być problem (agent już działa?)
            console.log('CLEANUP: UWAGA - Wykryto aktywną sesję (< 2 min)');
            console.log('CLEANUP: Możliwe że inny agent tester już działa!');
            console.log('CLEANUP: Resetuję dla bezpieczeństwa...');
            resetSession(testData, 'Reset przy starcie nowej sesji');
        }

    } catch (err) {
        console.error('CLEANUP: Błąd:', err.message);
        process.exit(1);
    }
}

function resetSession(testData, reason) {
    const now = new Date().toISOString().slice(0, 19);

    // Zachowaj startedAt poprzedniej sesji do logowania
    const prevStartedAt = testData.agentStatus?.startedAt || 'nieznany';

    testData.lastUpdate = now;
    testData.agentStatus = {
        isRunning: false,
        currentAction: null,
        lastAction: reason,
        finished: true,
        startedAt: prevStartedAt,
        finishedAt: now
    };
    testData.currentTest = null;

    if (testData.summary) {
        testData.summary.inProgress = 0;
    }

    // Zapisz plik
    const newContent = `// Auto-generated by Test Monitor\nvar testData = ${JSON.stringify(testData, null, 2)};\n`;
    fs.writeFileSync(MONITOR_FILE, newContent, 'utf8');

    console.log(`CLEANUP: Sesja zresetowana`);
    console.log(`  Poprzedni start: ${prevStartedAt}`);
    console.log(`  Powód: ${reason}`);
    console.log(`  Czas resetu: ${now}`);
}

// Uruchom
cleanupStaleSession();
